##### Zk原理架构简单介绍下？

zk是一个开源的，分布式协同服务系统，主要是将常见的分布式协同服务封装起来，并对外提供简单的api来达到 用户易用的目的。首先zk正常使用是奇数的集群模式。

从zk的客户端视角来看，client 允许与集群中的每个节点都可以建立链接，并且由于zk 自身的读写机制可以保障client连接不同节点看到的数据是一致的。

从zk自身视角来看，每个不同的zk节点 分为三种角色，leader  follower 或者 observer。 leader节点负责读写请求，follower节点负责读请求， follower还负责和leader保持数据同步，每个节点都允许与客户端通信，且zk自身的读写机制会让每个client看到的数据保持一致。

同时zk集群在发生故障的时候，整体会进入崩溃恢复状态，会重新选择出新的leader 节点，保障了整体的集群可用性

同时zk使用了类似unix 文件系统的设计，并且提供了不同类型的数据节点，比如类似 临时、永久数据节点的特性，方便用户使用zk可以简单的实现分布式锁等操作。

##### zk节点是怎么存储数据的

zk底层数据结构的逻辑结构就像unix 文件系统一样，树状多叉，每个节点被称为znode，不仅可以保存路径，还可以保存少量的数据（1m），实际上代码实现上就是 大型的concurrentHashMap<String（全路径），ZNode>。

###### 每个Znode分为2种类型

持久性znode/临时性znode：在客户端建立连接的时候立刻创建，一旦客户端断开（读写，心跳），session失效，节点 仍然存在或者不存在，临时节点不允许有子节点

节点也分为有序节点/无序节点：无序号节点相同则报错，有序节点在创建后会返回节点名和自动累加的序号，因为创建节点的操作只有leader节点才能做，并且在内部实际是使用synchronized加锁的，所以这个序号可以保证**安全递增**。

客户端应用可以在节点上设置监视器；

节点不支持部分读写，而是一次性完整读写。

所以使用 有序临时节点 就可以方便的实现分布式锁的语义。

##### zk可以做哪些事情

- 分布式锁
- 分布式配置服务，比如一些meta data的存储
- 分布式协同服务，比如选举

##### zk分布式锁是怎么实现的？

使用 有序临时节点 就可以方便的实现分布式锁的语义。

##### paxos算法是怎么回事？

##### chubby 和 zk区别是啥

Zookeeper是Chubby开源实现，chubby是google内部使用的，区别大概以下

- 协议不同。zk是zab，chubby是带租约的paxos。
- API 不同。zk可以用临时z节点实现锁，chubby有直接的加锁API。
- zk 设计为高吞吐量，每个机器都可以读，提供sync方法刷新值。chubby读写都在master单机上。

##### raft协议 和 paxos 区别



##### zab协议是什么？

Zookeeper的核心是原子广播，这个机制保证了各个server之间的同步。实现这个机制的协议叫做Zab协议。Zab协议有两种模式，它们分别是：恢复模式和广播模式。当服务启动或者在领导者崩溃后，Zab就进入了恢复模式，当领导者被选举出来，且大多数server的完成了和leader的状态同步以后，恢复模式就结束了，进入广播模式。

##### zab协议和paxos协议区别是什么？

ZAB全称是：ZooKeeper Atomic Broadcast 

总的来讲，ZAB协议和Paxos算法的本质区别在于，两者的设计目标不太一样。ZAB协议主要用于构建一个高可用的分布式数据主备系统，例如Zookeeper，而Paxos算法则是用于构建一个分布式的一致性状态机系统。

##### etcd 原理是什么 ？

##### etcd和zk区别是什么

etcd是一个分布式的高可用kv系统，可以用来实现各种分布式协同服务。基于go实现，采用的一致性算法是raft。k8s是用etcd来作为服务发现和配置管理。

etcd和zk基本覆盖相同的协同服务场景，zk因为需要把数据加载到内存里，一般存储的数据也就是几百mb，etcd使用不同的数据模型，可以存储几G的数据。

##### kafka是怎么使用zk的？

Kafka基本是重度依赖zk，使用zk实现了大量的分布式协同服务，比如

- broker的注册信息
- topic和broker的映射关系，partition关系 
- consumer 在zk中注册，包括新的消费者，新的消费者组
- producer 监听 broker列表实现 负载均衡
- consumer的消费进度 offset 也靠zk管理
- consumer 和 对应partition关系 也是zk管理的，实现消费者的负载均衡

